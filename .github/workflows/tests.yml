name: Tests

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    steps:
      # If this workflow is triggered by the same event, the previous runs are cancelled for optimization.
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.10.0
        with:
          access_token: ${{ github.token }}

  # Run our test script.
  # NOTE: This job is copied WITHOUT modifications from https://github.com/bdrelling/ci/.github/workflows/swift_test.yml
  swift_test:
    name: ${{ matrix.inputs.build-method }} test (${{ matrix.inputs.platform }}, swift ${{ matrix.inputs.swift-version }})
    runs-on: ${{ matrix.inputs.runner }}
    needs: [prepare]
    strategy:
      fail-fast: false
      matrix:
        inputs:
          - {
              runner: macos-11,
              platform: macOS,
              build-method: swift,
              swift-version: 5.3,
            }
          - {
              runner: macos-11,
              platform: macOS,
              build-method: swift,
              swift-version: 5.4,
            }
          - {
              runner: macos-12,
              platform: macOS,
              build-method: swift,
              swift-version: 5.5,
            }
          - {
              runner: macos-12,
              platform: macOS,
              build-method: swift,
              swift-version: 5.6,
            }
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Run Tests
        uses: bdrelling/ci/.github/actions/swift-test@main
        with:
          scheme: ${{ env.scheme }}
          platform: ${{ matrix.inputs.platform }}
          build-method: ${{ matrix.inputs.build-method }}
          swift-version: ${{ matrix.inputs.swift-version }}

  build_demo:
    name: Build ${{ matrix.scheme }} (Xcode ${{ matrix.xcode_version }})
    # NOTE: macos-latest is NOT equivalent to macos-12 as of September 2022.
    # Source: https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources
    runs-on: macos-12
    needs: [swift_test]
    strategy:
      # Disabling fail-fast ensures that the job will run all configurations of the matrix, even if one fails.
      fail-fast: false
      matrix:
        scheme:
          - FlowDemo (iOS)
          - FlowDemo (macOS)
        xcode_version:
          - '13.2' # swift 5.5
          - '13.4' # swift 5.6
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Xcode
        # Documentation: https://github.com/marketplace/actions/setup-xcode-version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ matrix.xcode_version }}
      - name: Build Demo
        run: xcodebuild clean build -project 'Demo/FlowDemo.xcodeproj' -scheme '${{ matrix.scheme }}' CODE_SIGNING_ALLOWED=NO
